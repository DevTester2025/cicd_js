name: Rollback_Test2

on:
  workflow_dispatch:

jobs:
  build:
    name: GITHUB
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

  BUILD_SCRIPT:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Run build script on VM over SSH
        run: |
          sshpass -p "a7X2p9L4kR" ssh -p 222 -o StrictHostKeyChecking=no omnisecure@51.21.247.48 << 'ENDSSH'
            echo "Executing on Server1:"
            echo "Private IP:$(hostname -I)";
            echo "Public IP:$(curl -s ifconfig.me)";
            hostnamectl
            cd ~/projects/apps/sample_project
            source ~/.nvm/nvm.sh
            nvm use default
            node -v
            pwd
            rm -rf node_modules package-lock.json dist
            npm install
            ng build

             echo "Checking if FTP is installed and running..."

            # Check if vsftpd or proftpd is installed
            if dpkg -l | grep -q vsftpd; then
              echo "vsftpd is installed"
              systemctl status vsftpd || echo "vsftpd service is not running"
            elif dpkg -l | grep -q proftpd; then
              echo "proftpd is installed"
              systemctl status proftpd || echo "proftpd service is not running"
            else
              echo "No FTP server installed"
            fi

            # Check if FTP port 21 is listening
            if ss -tuln | grep -q ':21'; then
              echo "FTP port (21) is open"
            else
              echo "FTP port (21) is not open"
            fi
            
            # FTP Upload Section
            echo "Uploading build via FTP..."
            apt-get update && apt-get install -y ftp
            ftp -inv 51.21.247.48 <<EOF
            user omnisecure a7X2p9L4kR
            cd /ftp/deploy
            put dist/angular-conduit/app.zip
            bye
            EOF
          ENDSSH
